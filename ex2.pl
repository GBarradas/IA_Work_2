%%%% v(p(COLUNA, LINHA), DOMINIO, VALOR)
estado_inicial(e([v(p(1, 1), [1,2,3,4,5,6,7,8,9], _), v(p(1, 3), [1,2,3,4,5,6,7,8,9], _), v(p(1, 4), [1,2,3,4,5,6,7,8,9], _), v(p(1, 5), [1,2,3,4,5,6,7,8,9], _), v(p(1, 7), [1,2,3,4,5,6,7,8,9], _),
        v(p(2, 1), [1,2,3,4,5,6,7,8,9], _), v(p(2, 2), [1,2,3,4,5,6,7,8,9], _), v(p(2, 3), [1,2,3,4,5,6,7,8,9], _), v(p(2, 5), [1,2,3,4,5,6,7,8,9], _), v(p(2, 7), [1,2,3,4,5,6,7,8,9], _), v(p(2, 8), [1,2,3,4,5,6,7,8,9], _), v(p(2, 9), [1,2,3,4,5,6,7,8,9], _),
        v(p(3, 2), [1,2,3,4,5,6,7,8,9], _), v(p(3, 3), [1,2,3,4,5,6,7,8,9], _), v(p(3, 4), [1,2,3,4,5,6,7,8,9], _), v(p(3, 5), [1,2,3,4,5,6,7,8,9], _), v(p(3, 6), [1,2,3,4,5,6,7,8,9], _), v(p(3, 8), [1,2,3,4,5,6,7,8,9], _),
        v(p(4, 1), [1,2,3,4,5,6,7,8,9], _), v(p(4, 2), [1,2,3,4,5,6,7,8,9], _), v(p(4, 3), [1,2,3,4,5,6,7,8,9], _), v(p(4, 4), [1,2,3,4,5,6,7,8,9], _), v(p(4, 5), [1,2,3,4,5,6,7,8,9], _), v(p(4, 7), [1,2,3,4,5,6,7,8,9], _), v(p(4, 8), [1,2,3,4,5,6,7,8,9], _), v(p(4, 9), [1,2,3,4,5,6,7,8,9], _),
        v(p(5, 1), [1,2,3,4,5,6,7,8,9], _), v(p(5, 2), [1,2,3,4,5,6,7,8,9], _), v(p(5, 3), [1,2,3,4,5,6,7,8,9], _), v(p(5, 4), [1,2,3,4,5,6,7,8,9], _), v(p(5, 7), [1,2,3,4,5,6,7,8,9], _), 
        v(p(6, 2), [1,2,3,4,5,6,7,8,9], _), v(p(6, 3), [1,2,3,4,5,6,7,8,9], _), v(p(6, 5), [1,2,3,4,5,6,7,8,9], _), v(p(6, 6), [1,2,3,4,5,6,7,8,9], _), v(p(6, 7), [1,2,3,4,5,6,7,8,9], _), v(p(6, 8), [1,2,3,4,5,6,7,8,9], _), v(p(6, 9), [1,2,3,4,5,6,7,8,9], _),
        v(p(7, 1), [1,2,3,4,5,6,7,8,9], _), v(p(7, 2), [1,2,3,4,5,6,7,8,9], _), v(p(7, 3), [1,2,3,4,5,6,7,8,9], _), v(p(7, 5), [1,2,3,4,5,6,7,8,9], _), v(p(7, 6), [1,2,3,4,5,6,7,8,9], _), v(p(7, 7), [1,2,3,4,5,6,7,8,9], _), v(p(7, 8), [1,2,3,4,5,6,7,8,9], _), v(p(7, 9), [1,2,3,4,5,6,7,8,9], _),
        v(p(8, 3), [1,2,3,4,5,6,7,8,9], _), v(p(8, 4), [1,2,3,4,5,6,7,8,9], _), v(p(8, 6), [1,2,3,4,5,6,7,8,9], _), v(p(8, 7), [1,2,3,4,5,6,7,8,9], _), v(p(8, 9), [1,2,3,4,5,6,7,8,9], _), 
        v(p(9, 1), [1,2,3,4,5,6,7,8,9], _), v(p(9, 2), [1,2,3,4,5,6,7,8,9], _), v(p(9, 4), [1,2,3,4,5,6,7,8,9], _), v(p(9, 5), [1,2,3,4,5,6,7,8,9], _), v(p(9, 7), [1,2,3,4,5,6,7,8,9], _), v(p(9, 8), [1,2,3,4,5,6,7,8,9], _), v(p(9, 9), [1,2,3,4,5,6,7,8,9], _)],
        [v(p(1, 2), [1,2,3,4,5,6,7,8,9], 1), v(p(1, 6), [1,2,3,4,5,6,7,8,9], 8), v(p(1, 8), [1,2,3,4,5,6,7,8,9], 7), v(p(1, 9), [1,2,3,4,5,6,7,8,9], 3),
        v(p(2, 4), [1,2,3,4,5,6,7,8,9], 5), v(p(2, 6), [1,2,3,4,5,6,7,8,9], 9),
        v(p(3, 1), [1,2,3,4,5,6,7,8,9], 7), v(p(3, 7), [1,2,3,4,5,6,7,8,9], 9), v(p(3, 9), [1,2,3,4,5,6,7,8,9], 4),
        v(p(4, 6), [1,2,3,4,5,6,7,8,9], 4),
        v(p(5, 5), [1,2,3,4,5,6,7,8,9], 3), v(p(5, 6), [1,2,3,4,5,6,7,8,9], 5), v(p(5, 8), [1,2,3,4,5,6,7,8,9], 1), v(p(5, 9), [1,2,3,4,5,6,7,8,9], 8),
        v(p(6, 1), [1,2,3,4,5,6,7,8,9], 8), v(p(6, 4), [1,2,3,4,5,6,7,8,9], 9),
        v(p(7, 4), [1,2,3,4,5,6,7,8,9], 7),
        v(p(8, 1), [1,2,3,4,5,6,7,8,9], 2), v(p(8, 2), [1,2,3,4,5,6,7,8,9], 6), v(p(8, 5), [1,2,3,4,5,6,7,8,9], 4), v(p(8, 8), [1,2,3,4,5,6,7,8,9], 3),
        v(p(9, 3), [1,2,3,4,5,6,7,8,9], 5), v(p(9, 6), [1,2,3,4,5,6,7,8,9], 3)])).

% Tabuleiro resultante do estado inicial
/*
-------------------------------------
|   | 1 |   |   |   | 8 |   | 7 | 3 |
|---|---|---|---|---|---|---|---|---|
|   |   |   | 5 |   | 9 |   |   |   |
|---|---|---|---|---|---|---|---|---|
| 7 |   |   |   |   |   | 9 |   | 4 |
|---|---|---|---|---|---|---|---|---|
|   |   |   |   |   | 4 |   |   |   |
|---|---|---|---|---|---|---|---|---|
|   |   |   |   | 3 | 5 |   | 1 | 8 |
|---|---|---|---|---|---|---|---|---|
| 8 |   |   | 9 |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|
|   |   |   | 7 |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|
| 2 | 6 |   |   | 4 |   |   | 3 |   |
|---|---|---|---|---|---|---|---|---|
|   |   | 5 |   |   | 3 |   |   |   |
-------------------------------------
*/

%%%% Verifica se os elementos numa lista sao todos diferentes
  todos_diferentes([]).
  todos_diferentes([X|R]):-
    \+ member(X,R), todos_diferentes(R).

%%%% Verifica se os elementos sãi iguais
igual(X,X).

%%%% Restrições
verificar_restricoes(E) :- 
    verificar_linhas(E), 
    verificar_colunas(E),
    verificar_quadrantes(E).

verificar_linhas(e(NAOINTERESSA, [v(p(X,Y), D, V)|R])) :-
    findall(V1, member(v(p(X,_), _, V1), T), L),
    todos_diferentes([V|L]).

verificar_colunas(e([NAOINTERESSA, v(p(X,Y), D, V)|T])) :-
    findall(V1, member(v(p(_,Y), _, V1), T), L),
    todos_diferentes([V|L]).

verificar_quadrantes(e(_, L)) :-
    aux_quadrantes(L, 1, 1, 3, Q1), todos_diferentes(Q1),
    aux_quadrantes(L, 1, 4, 6, Q2), todos_diferentes(Q2),
    aux_quadrantes(L, 1, 7, 9, Q3), todos_diferentes(Q3),
    aux_quadrantes(L, 4, 1, 3, Q4), todos_diferentes(Q4),
    aux_quadrantes(L, 4, 4, 6, Q5), todos_diferentes(Q5),
    aux_quadrantes(L, 4, 7, 9, Q6), todos_diferentes(Q6),
    aux_quadrantes(L, 7, 1, 3, Q7), todos_diferentes(Q7),
    aux_quadrantes(L, 7, 4, 6, Q8), todos_diferentes(Q8),
    aux_quadrantes(L, 7, 7, 9, Q9), todos_diferentes(Q9).

aux_quadrantes(L, X, Y, Y2, Q) :-
    Y = Y2, X1 is X+2,
    adicionar_quadrante(L, X, Y, X1, Q).
aux_quadrantes(L, X, Y, Y2, Q) :-
    Y < Y2, Y1 is Y+1,
    X1 is X+2,
    adicionar_quadrante(L, X, Y, X1, L1),
    append(L1, L2, Q),
    aux_quadrantes(L, X, Y1, Y2, L2).

adicionar_quadrante(L, X, Y, X2, []) :-
    X = X2,
    \+member(v(p(X,Y), _, _), L).
adicionar_quadrante(L, X, Y, X2, [V]) :-
    X = X2,
    member(v(p(X,Y), _, V), L).
adicionar_quadrante(L, X, Y, X2, L2) :-
    X < X2, X1 is X+1,
    \+member(v(p(X,Y), _, _), L),
    adicionar_quadrante(L, X1, Y, X2, L2).
adicionar_quadrante(L, X, Y, X2, [V|L2]) :-
    X < X2,
    member(v(p(X,Y), _, V), L),
    X1 is X+1,
    adicionar_quadrante(L, X1, Y, X2, L2).

%%%% Função responsável por printar o jogo no seu estado final
printar(J) :- sort(J, J1), aux_printar(J1), nl.

aux_printar(J) :- printar_linha(J, 1, 9).

printar_linha([v(_,_,X)|T], I, S) :-
    I<S, I2 is I+1,
    write(X), write(' . '),
    printar_linha(T, I2, S).

    % ultima linha
printar_linha([v(_,_,X)|T], S, S) :-
    write(X), nl,
    printar_linha(T, 1, S).

printar_linha([v(_,_,X)], S, S) :-
    write(X), nl.

%%%% Função sucessor
sucessor(e([v(P,N,_)|T], E), e(T, [v(P,D,V)|E])) :-
    member(V, D).

%%%% Função Backtracking
backtracking(e([], L), L).
backtracking(E, SOLUCAO) :-
    sucessor(E, E1),
    verificar_restricoes(E1),
    backtracking(E1, SOLUCAO).

%%%% Função forward
forward(e([], L), L).
forward(E, SOLUCAO) :-
    sucessor(E, E1),
    verificar_restricoes(E1),
    forward_check(E1, E2),
    forward(E2, SOLUCAO).

forward_check(e(L1, [v(P,D,V)|T]), e(L2, [v(P,D,V)|T])) :- 
    corta(V, L1, L2).

corta(_, [], []).
corta(V, [v(P,D,_)|T], [v(P,D2,_)|T2]) :-
    corta(V, T, T2).

sudoku_b :-
    estado_inicial(E),
    backtracking(E, J),
    printar(J).

sudoku_f :-
    estado_inicial(E),
    forward(E, J),
    printar(J).